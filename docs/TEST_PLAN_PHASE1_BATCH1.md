# Phase 1 (Batch 1) テスト方針書

## 概要
`app/api/assignments/` 配下の以下のルートに対してテストを実装します。

## 対象ファイル
1. `app/api/assignments/[id]/route.ts`
2. `app/api/assignments/batch/route.ts`
3. `app/api/assignments/batch-create/route.ts`

## テストケース一覧

### 1. `app/api/assignments/[id]/route.test.ts`

#### GET
- [ ] **正常系**: ID指定で配置とProjectMaster情報を取得できること (200)
- [ ] **準正常系**: 存在しないIDを指定した場合に404が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### PATCH
- [ ] **正常系**: 基本フィールド（memberCount, remarks等）を更新できること (200)
- [ ] **正常系**: 関連テーブル（workers, vehicles）を更新できること (200)
- [ ] **正常系**: 楽観的ロック - expectedUpdatedAtが一致する場合に更新できること (200)
- [ ] **正常系**: 楽観的ロックなし - expectedUpdatedAtを指定せずに更新できること (200)
- [ ] **準正常系**: 楽観的ロック - expectedUpdatedAtが不一致の場合に409が返ること (Conflict)
- [ ] **準正常系**: 権限がないユーザー（canDispatch=false）の場合に403が返ること
- [ ] **準正常系**: 存在しないIDを指定した場合に404が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### DELETE
- [ ] **正常系**: ID指定で配置を削除できること (200)
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

### 2. `app/api/assignments/batch/route.test.ts`

#### POST
- [ ] **正常系**: 複数の配置を一括更新できること (200)
- [ ] **正常系**: 楽観的ロック - 全てのexpectedUpdatedAtが一致する場合に更新できること (200)
- [ ] **正常系**: 楽観的ロックなし - expectedUpdatedAtを指定せずに更新できること (200)
- [ ] **準正常系**: 楽観的ロック - 1つでも不一致があれば更新せず409を返すこと
- [ ] **準正常系**: updates配列が空または不正な場合に400が返ること
- [ ] **準正常系**: 指定したIDの配置が存在しない場合（楽観的ロックあり）に400が返ること
- [ ] **異常系**: 指定したIDの配置が存在しない場合（楽観的ロックなし）に500が返ること
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **異常系**: トランザクション内でDBエラーが発生した場合に500が返ること

### 3. `app/api/assignments/batch-create/route.test.ts`

#### POST
- [ ] **正常系**: 複数の配置を一括作成できること (200)
- [ ] **準正常系**: assignments配列がない場合に400が返ること
- [ ] **準正常系**: 100件を超える場合に400が返ること
- [ ] **準正常系**: 必須フィールド（projectMasterId等）が欠けている場合に400が返ること
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **準正常系**: レートリミット超過時に429が返ること

## 実装方針
- 既存の `__tests__/api/assignments/route.test.ts` のモック構成を踏襲する。
- `prisma`, `requireAuth`, `applyRateLimit`, `canDispatch` をモック化する。
- `prisma.$transaction` のモック挙動を適切に設定する。
