# Phase 1 (Batch 2) テスト方針書

## 概要
`app/api/master-data/` 配下の以下のルートに対してテストを実装します。

## 対象ファイル
1. `app/api/master-data/route.ts`
2. `app/api/master-data/vehicles/route.ts`
3. `app/api/master-data/vehicles/[id]/route.ts`
4. `app/api/master-data/workers/route.ts`
5. `app/api/master-data/workers/[id]/route.ts`

## テストケース一覧

### 1. `app/api/master-data/route.test.ts`

#### GET
- [ ] **正常系**: 車両・作業員・職長・設定を一括取得できること (200)
- [ ] **正常系**: 設定がない場合（デフォルト値）の挙動を確認 (200)
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

### 2. `app/api/master-data/vehicles/route.test.ts`

#### GET
- [ ] **正常系**: アクティブな車両一覧を取得できること (200)
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### POST
- [ ] **正常系**: 車両を作成できること (201)
- [ ] **準正常系**: バリデーションエラー（名前が空、長すぎる等）の場合に400が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

### 3. `app/api/master-data/vehicles/[id]/route.test.ts`

#### PATCH
- [ ] **正常系**: 車両名を更新できること (200)
- [ ] **準正常系**: バリデーションエラー（名前が空、長すぎる等）の場合に400が返ること
- [ ] **準正常系**: 権限がないユーザー（一般ユーザー等）の場合に403が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### DELETE
- [ ] **正常系**: 車両を論理削除（isActive: false）できること (200)
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

### 4. `app/api/master-data/workers/route.test.ts`

※ `vehicles` と同様のロジックのため、構成を統一する。

#### GET
- [ ] **正常系**: アクティブな作業員一覧を取得できること (200)
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### POST
- [ ] **正常系**: 作業員を作成できること (201)
- [ ] **準正常系**: バリデーションエラーの場合に400が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

### 5. `app/api/master-data/workers/[id]/route.test.ts`

#### PATCH
- [ ] **正常系**: 作業員名を更新できること (200)
- [ ] **準正常系**: バリデーションエラーの場合に400が返ること
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

#### DELETE
- [ ] **正常系**: 作業員を論理削除できること (200)
- [ ] **準正常系**: 権限がないユーザーの場合に403が返ること
- [ ] **異常系**: 未認証の場合に401が返ること
- [ ] **異常系**: DBエラー時に500が返ること

## 実装方針
- 共通して `prisma`, `requireAuth` をモック化。
- 個別操作（PATCH, DELETE）では `isManagerOrAbove` をモック化し、権限チェックのテストを行う。
- `validateStringField` のモック:
    - 正常時は値をそのまま返す。
    - 異常時は `NextResponse` (400) を返すようにモックし、routes側でそれがリターンされるか確認する。
